// API pour approuver un professeur en attente
import { MongoClient, ObjectId } from 'mongodb';

// Singleton pour maintenir la connexion √† MongoDB
let client = null;
let db = null;

async function connectToMongoDB() {
  if (db) {
    return db;
  }

  const config = useRuntimeConfig();
  const url = config.DATABASE_URL || 'mongodb://localhost:27017/academ-message-db';
  
  try {
    if (!client) {
      client = new MongoClient(url);
      await client.connect();
      console.log('Connexion √† MongoDB √©tablie');
    }
    
    db = client.db();
    return db;
  } catch (error) {
    console.error('Erreur de connexion √† MongoDB:', error);
    throw error;
  }
}

// Configuration du transporteur email
const createTransporter = async () => {
  try {
    const nodemailer = await import('nodemailer');
    const config = useRuntimeConfig();
    
    return nodemailer.default.createTransporter({
      host: config.smtpHost || 'smtp.gmail.com',
      port: config.smtpPort || 587,
      secure: false,
      auth: {
        user: config.smtpUser,
        pass: config.smtpPass
      }
    });
  } catch (error) {
    console.error('Erreur lors de la cr√©ation du transporteur email:', error);
    throw error;
  }
};

// Email de confirmation d'approbation
async function sendApprovalConfirmationEmail({ to, firstName, lastName }) {
  const config = useRuntimeConfig();
  
  if (!config.smtpUser || !config.smtpPass) {
    console.warn('‚ö†Ô∏è Variables SMTP non configur√©es. Email non envoy√©.');
    return { success: false, message: 'Variables SMTP non configur√©es' };
  }

  const subject = 'F√©licitations ! Votre compte professeur a √©t√© approuv√© - Academ';
  const baseUrl = config.baseUrl || 'https://academ.my';
  
  const htmlContent = `
    <!DOCTYPE html>
    <html lang="fr">
    <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>Compte approuv√© - Academ</title>
      <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; line-height: 1.6; color: #333; max-width: 600px; margin: 0 auto; padding: 20px; }
        .header { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 30px; text-align: center; border-radius: 10px 10px 0 0; }
        .content { background: #f8f9fa; padding: 30px; border-radius: 0 0 10px 10px; }
        .button { display: inline-block; background: #10b981; color: white; padding: 15px 30px; text-decoration: none; border-radius: 6px; margin: 20px 0; font-weight: bold; }
      </style>
    </head>
    <body>
      <div class="header">
        <h1>üéâ F√©licitations !</h1>
        <p>Votre compte a √©t√© approuv√©</p>
      </div>
      <div class="content">
        <p>Bonjour ${firstName} ${lastName},</p>
        <p><strong>Excellente nouvelle !</strong> Votre profil de professeur a √©t√© approuv√© par notre √©quipe.</p>
        <p>Vous pouvez maintenant acc√©der √† votre espace professeur et commencer √† enseigner sur Academ.</p>
        <a href="${baseUrl}/login" class="button">üöÄ Acc√©der √† mon espace professeur</a>
        <p>Bienvenue dans la communaut√© Academ !</p>
        <p>Cordialement,<br>L'√©quipe Academ</p>
      </div>
    </body>
    </html>
  `;

  try {
    const transporter = await createTransporter();
    const mailOptions = {
      from: config.smtpFrom || 'noreply@academ-message.com',
      to: to,
      subject: subject,
      html: htmlContent
    };

    const info = await transporter.sendMail(mailOptions);
    console.log('‚úÖ Email d\'approbation envoy√©:', info.messageId);
    return { success: true, messageId: info.messageId };
  } catch (error) {
    console.error('‚ùå Erreur lors de l\'envoi de l\'email d\'approbation:', error);
    throw error;
  }
}

export default defineEventHandler(async (event) => {
  try {
    // V√©rifier l'authentification et le r√¥le admin
    if (!event.context.auth?.user) {
      return createError({
        statusCode: 401,
        statusMessage: 'Unauthorized',
        message: 'Authentification requise'
      });
    }

    if (event.context.auth.user.role !== 'admin') {
      return createError({
        statusCode: 403,
        statusMessage: 'Forbidden',
        message: 'Acc√®s r√©serv√© aux administrateurs'
      });
    }

    const userId = getRouterParam(event, 'id');
    if (!userId) {
      return createError({
        statusCode: 400,
        statusMessage: 'Bad Request',
        message: 'ID utilisateur requis'
      });
    }

    const database = await connectToMongoDB();

    // R√©cup√©rer l'utilisateur
    const objectId = new ObjectId(userId);
    const user = await database.collection('users').findOne({ _id: objectId });
    if (!user) {
      return createError({
        statusCode: 404,
        statusMessage: 'Not Found',
        message: 'Utilisateur non trouv√©'
      });
    }

    // V√©rifier que c'est un professeur en attente
    if (user.role !== 'teacher') {
      return createError({
        statusCode: 400,
        statusMessage: 'Bad Request',
        message: 'Seuls les professeurs peuvent √™tre approuv√©s'
      });
    }

    if (user.status !== 'pending') {
      return createError({
        statusCode: 400,
        statusMessage: 'Bad Request',
        message: 'Cet utilisateur n\'est pas en attente d\'approbation'
      });
    }

    // Mettre √† jour le statut √† "active"
    const updateResult = await database.collection('users').updateOne(
      { _id: objectId },
      { 
        $set: {
          status: 'active',
          approvedAt: new Date(),
          approvedBy: new ObjectId(event.context.auth.user._id),
          updatedAt: new Date()
        }
      }
    );

    if (updateResult.modifiedCount === 0) {
      return createError({
        statusCode: 500,
        statusMessage: 'Internal Server Error',
        message: 'Erreur lors de l\'approbation de l\'utilisateur'
      });
    }

    // Envoyer l'email de confirmation d'approbation
    try {
      await sendApprovalConfirmationEmail({
        to: user.email,
        firstName: user.firstName,
        lastName: user.lastName
      });
      console.log('‚úÖ Email d\'approbation envoy√© √†:', user.email);
    } catch (emailError) {
      console.error('‚ùå Erreur lors de l\'envoi de l\'email d\'approbation:', emailError);
      // On continue m√™me si l'email √©choue
    }

    // R√©cup√©rer l'utilisateur mis √† jour
    const updatedUser = await database.collection('users').findOne({ _id: objectId });

    console.log(`‚úÖ Professeur approuv√© par l'admin ${event.context.auth.user.email}:`, {
      userId: userId,
      teacherEmail: user.email,
      approvedBy: event.context.auth.user._id
    });

    return {
      success: true,
      message: `Le professeur ${user.firstName} ${user.lastName} a √©t√© approuv√© avec succ√®s`,
      user: {
        _id: updatedUser._id,
        firstName: updatedUser.firstName,
        lastName: updatedUser.lastName,
        email: updatedUser.email,
        role: updatedUser.role,
        status: updatedUser.status,
        approvedAt: updatedUser.approvedAt
      }
    };

  } catch (error) {
    console.error('Erreur lors de l\'approbation du professeur:', error);
    return createError({
      statusCode: 500,
      statusMessage: 'Internal Server Error',
      message: `Erreur lors de l\'approbation: ${error.message}`
    });
  }
});